<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme-color" content="#000000">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <!-- axiosã‚’å®šç¾© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <main id="main">
    <h2>chatGPTã¨Lineã™ã‚‹ã€‚</h2>
    <!-- gptã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãŒå…¥ã£ã¦ãã‚‹ -->
    <div class="myinput"></div>
    <div class="gptoutput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼š<input type="text" name="pass" id="pass"></div>
      <div class="character">æ€§æ ¼ã‚’å…¥åŠ›ã€‚åˆæœŸè¨­å®šã¯ãƒ¡ã‚¤ãƒ‰ã§ã™ã€‚<input type="text" name="character" id="character" placeholder="ã‚ãªãŸã¯ï½ãªäººã§ã™ã€‚çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã„ã¾ã™ã€‚"></div>
    <div id="Line">
      <div class="gptResponse">å§‹ã‚ã‚‹ã«ã¯æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ã‹ğŸ¤ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ã­ã€‚</div>
    </div>

    <div id="user-click">
      <button type="button" class="start">ğŸ¤</button>  
      <button type="button" class="stop">â– </button>
      <div></div>
      <input type="text" name="talk">
      <button type="button" class="send">chatGPTã«é€ã‚‹</button>
    </div>
    
  </main>
  
  <script type="text/javascript" src="script.js"></script>

  <script>
    //éŸ³å£°èªè­˜ã—æ–‡å­—èµ·ã“ã—-----------------------
    const recognition = new webkitSpeechRecognition(); // prefix å¿…è¦ SpeechRecognition
    recognition.lang = "ja";
    recognition.continuous = true;

    //çµæœ
    recognition.onresult = async({ results }) => {//éŸ³å£°èªè­˜ã®ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ããŸã‚‰chatgptã«æŠ•ã’ã€éŸ³å£°

      //ã¾ãšï¼’ã¤ã®divã‚’è¿½åŠ 
      const myQuestion = document.createElement("div");
      const gptResponse = document.createElement("div");
      myQuestion.className = "myQuestion";
      gptResponse.className = "gptResponse";

      //è‡ªåˆ†ã®è³ªå•ã‚’è¡¨ç¤º
      console.log(results[0][0].transcript)
      myQuestion.textContent = results[0][0].transcript;
      document.getElementById('Line').appendChild(myQuestion);

      console.log("å®Ÿè¡Œ1");

      const responseText = await requestChatAPI(results[0][0].transcript);//â‘ ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã«å…¥ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’chatgptã«æŠ•ã’ã‚‹é–¢æ•°ã«å…¥ã‚Œã‚‹ã€‚â‘¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ãã‚‹

      console.log("å®Ÿè¡Œ2");
      console.log(responseText)
      gptResponse.innerText = responseText;//output(å…¥åŠ›æ¬„ã®ä¸‹ã«gptã®è¿”ç­”ãŒè¿”ã•ã‚Œã‚‹ã€‚)
      document.getElementById('Line').appendChild(gptResponse);

      createAudio(responseText);//ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ããŸã‚‰èª­ã¿ä¸Šã’ã‚‹ã€‚
    };
    //éŸ³å£°èªè­˜é–‹å§‹
    const startButton = document.querySelector(".start");
    startButton.addEventListener("click", () => {
      recognition.start();
    });
    //éŸ³å£°èªè­˜çµ‚äº†
    const stopButton = document.querySelector(".stop");
    stopButton.addEventListener("click", () => {
      recognition.stop();
    });
  </script>
  
  <script>
    // TODO:
    
    const sendButton = document.querySelector(".send");

    //api_keyã®æš—å·åŒ–
    //const api_key = "ï¼Ÿï¼Ÿï¼Ÿ";
    //const passPhrase = "ï¼Ÿï¼Ÿï¼Ÿ"; //ç§˜å¯†ã‚­ãƒ¼
    //const encryptedTxt = CryptoJS.AES.encrypt(api_key, passPhrase);
    //console.log(encryptedTxt.toString());

    //å¾©å·åŒ–
    //é–¢æ•°ã®ä¸­ã¸

    
    //é€ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«å®Ÿè¡Œã™ã‚‹äº‹
    sendButton.addEventListener("click", async () => {
      const myQuestion = document.createElement("div");
      const gptResponse = document.createElement("div");
      myQuestion.className = "myQuestion";
      gptResponse.className = "gptResponse";

//textã«ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ä¿å­˜ã€€

      const text = document.querySelector("[name=talk]");
      //responseTextãŒãƒãƒ£ãƒƒãƒˆgptã®è¿”ç­”ã€€å‰3ã¤ã®ãƒˆãƒ¼ã‚¯ã¯ä¿æŒã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ãŸã„ã€‚
      myQuestion.textContent = text.value;
      document.getElementById('Line').appendChild(myQuestion);
      text.value = "";

      const responseText = await requestChatAPI(myQuestion.textContent);//â‘ ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã«å…¥ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’chatgptã«æŠ•ã’ã‚‹é–¢æ•°ã«å…¥ã‚Œã‚‹ã€‚â‘¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ãã‚‹
      

      console.log(responseText)
      gptResponse.innerText = responseText;//output(å…¥åŠ›æ¬„ã®ä¸‹ã«gptã®è¿”ç­”ãŒè¿”ã•ã‚Œã‚‹ã€‚)
      document.getElementById('Line').appendChild(gptResponse);
      await createAudio(responseText);//ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ããŸã‚‰èª­ã¿ä¸Šã’ã‚‹ã€‚
    });
    
    //chatgptã«æŠ•ã’ã‚‹é–¢æ•°
    let history = []; // ä¼šè©±å±¥æ­´ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®é…åˆ—ã‚’ä½œæˆã—ã¾ã™ã€‚

    async function requestChatAPI(text) {
    //api_keyã®å¾©å·åŒ–
    const passElement = document.getElementsByName("pass")[0]//ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„
    const encryptedTxt = "U2FsdGVkX1/ygbRXBRyjxJcOcrPNdV1dnUVbjW8mvanObtkl7a4c7dHtqPCvOeBgzlyfeJ1jOHObQ2eCLZXh9bGiO2bCGhq1azyIdusRc1I="
    const api_key1 = CryptoJS.AES.decrypt(encryptedTxt, passElement.value).toString(
      CryptoJS.enc.Utf8
    ); //å¾©å·åŒ–
    console.log(api_key1);

      const headers = {
        "Content-Type": "application/json",
        Authorization: `Bearer ${api_key1}`,
      };

      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¾ã™ã€‚
      history.push(

        {
          role: "user",
          content: text,
      });

      // å±¥æ­´ãŒ4ã¤ä»¥ä¸Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
      if (history.length > 3) {
        history.shift();
        //é…åˆ—ã‚’é€†ã«ã™ã‚‹
        history.reverse();
        //é…åˆ—ã®é•·ã•ã‚’4ã«ã™ã‚‹
        history.length = 3
        //é…åˆ—ã‚’é€†ã«ã™ã‚‹
        history.reverse()
      }

      //æ€§æ ¼ã‚’ç”Ÿæˆ
      const personality = [{
        role: "system",
        content: "ã‚ãªãŸã¯ç§ã®ã‹ã‚ã„ã„ãƒ¡ã‚¤ãƒ‰ã§ã™ã€‚çµµæ–‡å­—ã‚’å¤šç”¨ã—ã¾ã™ã€‚"
      }];
      const character = document.getElementById("character")
      if (character.value.length !== 0) {
        personality[0].content = character.value
        console.log("a")
      }else {
      }
      console.log(personality)


      const payload = {
        model: "gpt-3.5-turbo",
        max_tokens: 512,
        messages: [...personality, ...history], // ä¼šè©±å±¥æ­´ã‚’payloadã«è¨­å®šã—ã¾ã™ã€‚
      };
      console.log(payload.messages)
      
      const response = await axios.post(
        "https://api.openai.com/v1/chat/completions",
        payload,
        {
          headers: headers,
        }
      );

      // å¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¾ã™ã€‚
      history.push({
        role: "assistant",
        content: response.data.choices[0].message.content,
      });

      return response.data.choices[0].message.content;
    }

    //éŸ³å£°èª­ã¿ä¸Šã’--------------------------------------------------------

    //speechSynthesis()ã€€éŸ³å£°åˆæˆ https://qiita.com/hmmrjn/items/be29c62ba4e4a02d305c
    function createAudio(text) {
      const uttr = new SpeechSynthesisUtterance();//éŸ³å£°åˆæˆã®APIã‚’å®šç¾©
      //æŠ•ã’ã‚‹æ–‡ç« 
      uttr.text = text;
      // è¨€èª (æ—¥æœ¬èª:ja-JP, ã‚¢ãƒ¡ãƒªã‚«è‹±èª:en-US, ã‚¤ã‚®ãƒªã‚¹è‹±èª:en-GB, ä¸­å›½èª:zh-CN, éŸ“å›½èª:ko-KR)
      uttr.lang = "ja-JP"
      // é€Ÿåº¦ 0.1-10 åˆæœŸå€¤:1 (å€é€Ÿãªã‚‰2, åŠåˆ†ã®å€é€Ÿãªã‚‰0.5)
      uttr.rate = 1.5
      // é«˜ã• 0-2 åˆæœŸå€¤:1
      uttr.pitch = 1.5;
      // éŸ³é‡ 0-1 åˆæœŸå€¤:1
      uttr.volume = 0.5

      //ç™ºè¨€ã‚’å†ç”Ÿ
      window.speechSynthesis.speak(uttr);
    }


  </script>
  <!-- <script>
    //éŸ³å£°èª­ã¿ä¸Šã’--------------------------------------------------------
    const readButton = document.querySelector(".read");
    //ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚èª­ã¿ä¸Šã’ã‚‹ã€€ãªã®ã§chatgptã®ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ããŸã¨ãã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆã«å¤‰æ›´
    readButton.addEventListener("click", async () => {
      const text = document.querySelector(".gptoutput");
      await createAudio(text.textContent);//createAudioã«å…¥åŠ›ã—ãŸæ–‡å­—ã‚’æŠ•ã’ã‚‹
    });


    //speechSynthesis()ã€€éŸ³å£°åˆæˆ https://qiita.com/hmmrjn/items/be29c62ba4e4a02d305c
    function createAudio(text) {
      const uttr = new SpeechSynthesisUtterance();//éŸ³å£°åˆæˆã®APIã‚’å®šç¾©
      //æŠ•ã’ã‚‹æ–‡ç« 
      uttr.text = text;
      // è¨€èª (æ—¥æœ¬èª:ja-JP, ã‚¢ãƒ¡ãƒªã‚«è‹±èª:en-US, ã‚¤ã‚®ãƒªã‚¹è‹±èª:en-GB, ä¸­å›½èª:zh-CN, éŸ“å›½èª:ko-KR)
      uttr.lang = "ja-JP"
      // é€Ÿåº¦ 0.1-10 åˆæœŸå€¤:1 (å€é€Ÿãªã‚‰2, åŠåˆ†ã®å€é€Ÿãªã‚‰0.5)
      uttr.rate = 1
      // é«˜ã• 0-2 åˆæœŸå€¤:1
      uttr.pitch = 0.25
      // éŸ³é‡ 0-1 åˆæœŸå€¤:1
      uttr.volume = 0.75

      //ç™ºè¨€ã‚’å†ç”Ÿ
      window.speechSynthesis.speak(uttr);
    }
  </script> -->


</body>


</html>

<!-- <script>

  let history = []; // ä¼šè©±å±¥æ­´ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®é…åˆ—ã‚’ä½œæˆã—ã¾ã™ã€‚

async function requestChatAPI(text) {
  const headers = {
    "Content-Type": "application/json",
    Authorization: `Bearer ${api_key}`,
  };

  // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¾ã™ã€‚
  history.push({
    role: "user",
    content: text,
  });

  // å±¥æ­´ãŒ3ã¤ä»¥ä¸Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
  if (history.length > 3) {
    history.shift();
  }

  const payload = {
    model: "gpt-3.5-turbo",
    max_tokens: 256,
    messages: history, // ä¼šè©±å±¥æ­´ã‚’payloadã«è¨­å®šã—ã¾ã™ã€‚
  };

  const response = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    payload,
    {
      headers: headers,
    }
  );

  // å¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¾ã™ã€‚
  history.push({
    role: "assistant",
    content: response.data.choices[0].message.content,
  });

  return response.data.choices[0].message.content;
}

</script> -->
